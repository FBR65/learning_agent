<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Universeller Lernagent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 30px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #666;
        }

        .tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            background: #f8f9fa;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: #212529;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        }

        /* Spaced Repetition Card Styles */
        .spaced-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card-question h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .card-stats {
            color: #6c757d;
            font-size: 0.9em;
            margin-top: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .answer-section {
            margin: 20px 0;
        }

        .answer-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .answer-input input {
            flex: 1;
        }

        .quality-section {
            margin-top: 20px;
            padding: 15px;
            border-top: 2px solid #e9ecef;
        }

        .answer-result {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .answer-result.correct {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .answer-result.incorrect {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .quality-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .quality-btn {
            font-size: 0.85em;
            padding: 8px 12px;
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background: #f8f9fa;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            background: #e9ecef;
        }

        .file-upload.dragover {
            border-color: #28a745;
            background: #d4edda;
        }

        .file-input {
            display: none;
        }

        .upload-icon {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 15px;
        }

        .question-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
        }

        .answer-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .feedback {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .feedback.correct {
            background: #d4edda;
            color: #155724;
        }

        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
        }

        .spaced-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: border-color 0.3s ease;
        }

        .spaced-card:hover {
            border-color: #667eea;
        }

        .quality-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .quality-btn {
            flex: 1;
            min-width: 120px;
            padding: 10px;
            font-size: 14px;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .tabs {
                flex-direction: column;
            }

            .quality-buttons {
                flex-direction: column;
            }

            .quality-btn {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Universeller Lernagent</h1>
            <p>K√ºnstliche Intelligenz f√ºr personalisiertes Lernen mit Spaced Repetition</p>
        </div>

        <div class="card">
            <div class="tabs">
                <button class="tab active" onclick="showTab('upload')">ÔøΩ Upload</button>
                <button class="tab" onclick="showTab('scenarios')">ÔøΩ Szenarien</button>
                <button class="tab" onclick="showTab('learning')">üéì Lernen</button>
                <button class="tab" onclick="showTab('repetition')">üîÑ Wiederholung</button>
                <button class="tab" onclick="showTab('help')">‚ùì Hilfe</button>
            </div>

            <!-- Upload Tab -->
            <div id="upload" class="tab-content active">
                <h2>üìÅ Szenario hochladen</h2>
                
                <div class="form-group">
                    <h3>üìñ Dateiformat-Anleitung</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p><strong>Unterst√ºtzte Dateiformate:</strong> CSV, JSON, XML, Excel (.xls, .xlsx)</p>
                        
                        <h4>üìù CSV-Format (einfachste Methode):</h4>
                        <pre style="background: white; padding: 10px; border-radius: 4px; font-size: 12px;">Frage,Antwort,Kategorie,Schwierigkeit
"Was bedeutet 'puer'?","Junge","Latein",1
"Was bedeutet 'puella'?","M√§dchen","Latein",1
"Was ist 2+2?","4","Mathematik",1</pre>
                        
                        <h4>üî¢ JSON-Format (erweiterte Optionen):</h4>
                        <pre style="background: white; padding: 10px; border-radius: 4px; font-size: 12px;">{
  "name": "Mein Lernset",
  "description": "Beschreibung des Lernsets",
  "tasks": [
    {
      "question": "Was bedeutet 'puer'?",
      "answer": "Junge",
      "category": "Latein",
      "difficulty": 1
    }
  ]
}</pre>
                        
                        <p><strong>üí° Tipp:</strong> Beginnen Sie mit CSV - das ist am einfachsten! Die erste Zeile muss die Spalten√ºberschriften enthalten.</p>
                    </div>
                </div>
                
                <div class="file-upload" id="uploadArea">
                    <div class="upload-icon">üìÅ</div>
                    <h3>Datei hier ablegen oder klicken zum Ausw√§hlen</h3>
                    <p>Unterst√ºtzte Formate: CSV, JSON, XML, XLS, XLSX</p>
                    <input type="file" id="fileInput" class="file-input" accept=".csv,.json,.xml,.xls,.xlsx">
                    <button onclick="document.getElementById('fileInput').click()" class="btn">Datei ausw√§hlen</button>
                </div>
                
                <div class="form-group">
                    <h3>üìã Beispiel-Szenarien erstellen</h3>
                    <p>Falls noch keine Szenarien vorhanden sind, kannst du Beispiel-Szenarien erstellen:</p>
                    <button onclick="createSampleScenarios()" class="btn btn-secondary">Beispiel-Szenarien erstellen</button>
                </div>
                
                <div id="uploadStatus"></div>
            </div>

            <!-- Szenarien Tab -->
            <div id="scenarios" class="tab-content">
                <h2>üìö Verf√ºgbare Szenarien</h2>
                <div class="form-group">
                    <label for="scenarioSelect">Szenario ausw√§hlen:</label>
                    <select id="scenarioSelect" class="form-control">
                        <option value="">L√§dt Szenarien...</option>
                    </select>
                </div>
                <button onclick="loadScenario()" class="btn">Szenario laden</button>
                <div id="scenarioStatus"></div>
            </div>

            <!-- Upload Tab -->
            <div id="upload" class="tab-content">
                <h2>üìÅ Szenario hochladen</h2>
                <div class="file-upload" id="uploadArea">
                    <div class="upload-icon">üìÅ</div>
                    <h3>Datei hier ablegen oder klicken zum Ausw√§hlen</h3>
                    <p>Unterst√ºtzte Formate: CSV, JSON, XML, XLS, XLSX</p>
                    <input type="file" id="fileInput" class="file-input" accept=".csv,.json,.xml,.xls,.xlsx">
                    <button onclick="document.getElementById('fileInput').click()" class="btn">Datei ausw√§hlen</button>
                </div>
                <div id="uploadStatus"></div>
            </div>

            <!-- Learning Tab -->
            <div id="learning" class="tab-content">
                <h2>üéì Lern-Session</h2>
                <button onclick="startSession()" class="btn">Session starten</button>
                
                <div id="questionArea" class="hidden">
                    <div class="question-box">
                        <h3 id="questionText"></h3>
                    </div>
                    <input type="text" id="answerInput" class="answer-input" placeholder="Deine Antwort...">
                    <button onclick="submitAnswer()" class="btn">Antwort senden</button>
                </div>

                <div id="feedback"></div>
                
                <div id="sessionStats" class="hidden">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="questionsAnswered">0</div>
                            <div class="stat-label">Fragen beantwortet</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="accuracy">0%</div>
                            <div class="stat-label">Genauigkeit</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="currentStreak">0</div>
                            <div class="stat-label">Aktuelle Serie</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Spaced Repetition Tab -->
            <div id="repetition" class="tab-content">
                <h2>üîÑ Spaced Repetition</h2>
                
                <div id="sessionWarning" class="form-group" style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;">
                    <h3>‚ö†Ô∏è Erst lernen, dann wiederholen!</h3>
                    <p>Bevor du Wiederholungen machst, solltest du zuerst im <strong>üéì Lernen</strong>-Tab eine Session starten.</p>
                    <p>Dort lernst du neue Karten, die dann automatisch zum Wiederholungssystem hinzugef√ºgt werden.</p>
                    <button onclick="showTab('learning')" class="btn btn-secondary">Zum Lernen wechseln</button>
                </div>
                
                <button onclick="loadSpacedRepetition()" class="btn">F√§llige Karten laden</button>
                
                <div id="repetitionStatus"></div>
                
                <div id="spacedStats" class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="cardsDue">0</div>
                        <div class="stat-label">F√§llige Karten</div>
                    </div>
                </div>

                <div id="spacedCards"></div>
            </div>

            <!-- Hilfe Tab -->
            <div id="help" class="tab-content">
                <h2>‚ùì Hilfe & Anleitung</h2>
                
                <div class="form-group">
                    <h3>üöÄ Erste Schritte</h3>
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <ol style="margin: 0; padding-left: 20px;">
                            <li><strong>üìÅ Upload:</strong> Lade dein Lernmaterial hoch (CSV-Format ist am einfachsten)</li>
                            <li><strong>üìö Szenarien:</strong> W√§hle dein Lernset aus</li>
                            <li><strong>üéì Lernen:</strong> Starte eine Lernsession</li>
                            <li><strong>üîÑ Wiederholung:</strong> Wiederhole f√§llige Karten</li>
                        </ol>
                    </div>
                </div>
                
                <div class="form-group">
                    <h3>üìù Dateiformat f√ºr Upload</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4>CSV-Format (empfohlen):</h4>
                        <pre style="background: white; padding: 10px; border-radius: 4px; font-size: 12px;">Frage,Antwort,Kategorie,Schwierigkeit
"Was ist die Hauptstadt von Deutschland?","Berlin","Geografie",1
"Wie lautet die Formel f√ºr Wasser?","H2O","Chemie",1</pre>
                        
                        <p><strong>üí° Tipps:</strong></p>
                        <ul>
                            <li>Erste Zeile muss die Spalten√ºberschriften enthalten</li>
                            <li>Schwierigkeit: 1 = leicht, 2 = mittel, 3 = schwer</li>
                            <li>Kategorien helfen beim Organisieren der Fragen</li>
                            <li>Anf√ºhrungszeichen verwenden, wenn Text Kommas enth√§lt</li>
                        </ul>
                    </div>
                </div>
                
                <div class="form-group">
                    <h3>üîÑ Spaced Repetition System</h3>
                    <div style="background: #e6f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p><strong>So funktioniert das Lernsystem:</strong></p>
                        <ul>
                            <li><strong>Neue Karten:</strong> Werden nach 1 Tag wiederholt</li>
                            <li><strong>Richtige Antworten:</strong> L√§ngere Intervalle (1 ‚Üí 6 ‚Üí 13+ Tage)</li>
                            <li><strong>Falsche Antworten:</strong> Sofortige Wiederholung</li>
                            <li><strong>Bewertung:</strong> 0-2 = schwer, 3-5 = gut bis perfekt</li>
                        </ul>
                        <p><em>Das System passt sich automatisch an deine Leistung an!</em></p>
                    </div>
                </div>
                
                <div class="form-group">
                    <h3>üéØ Lerntipps</h3>
                    <div style="background: #fff8e1; padding: 15px; border-radius: 8px;">
                        <ul>
                            <li><strong>Regelm√§√üig lernen:</strong> Lieber 10 Minuten t√§glich als 1 Stunde einmal pro Woche</li>
                            <li><strong>Ehrlich bewerten:</strong> Bewerte deine Antworten realistisch</li>
                            <li><strong>Bei Unsicherheit:</strong> W√§hle eine niedrigere Bewertung</li>
                            <li><strong>Pausen machen:</strong> Bei M√ºdigkeit ist das Lernen weniger effektiv</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Globale Variablen
        let currentTaskId = null;
        let sessionActive = false;

        // Tab-Management
        function showTab(tabId) {
            // Alle Tabs deaktivieren
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Aktiven Tab aktivieren
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            // Tab-spezifische Aktionen
            if (tabId === 'scenarios' || tabId === 'auto-training') {
                loadScenarios();
            } else if (tabId === 'repetition') {
                loadSpacedRepetition();
            } else if (tabId === 'auto-training') {
                checkAutoTrainingStatus();
            }
        }

        // Szenarien laden
        async function loadScenarios() {
            try {
                console.log('Loading scenarios...');
                const response = await fetch('/api/scenarios');
                const data = await response.json();
                console.log('Scenarios loaded:', data);
                
                const select = document.getElementById('scenarioSelect');
                
                if (!select) {
                    console.error('scenarioSelect element not found');
                    return;
                }
                
                select.innerHTML = '<option value="">Szenario ausw√§hlen...</option>';
                
                if (data.scenarios && data.scenarios.length > 0) {
                    data.scenarios.forEach(scenario => {
                        const option = new Option(scenario, scenario);
                        select.add(option);
                    });
                    console.log('Scenarios added to select:', data.scenarios);
                } else {
                    console.log('No scenarios found');
                    select.innerHTML = '<option value="">Keine Szenarien verf√ºgbar</option>';
                }
            } catch (error) {
                console.error('Error loading scenarios:', error);
                const select = document.getElementById('scenarioSelect');
                if (select) {
                    select.innerHTML = '<option value="">Fehler beim Laden</option>';
                }
                showStatus('scenarios', 'Fehler beim Laden der Szenarien: ' + error.message, 'error');
            }
        }

        // Szenario laden
        async function loadScenario() {
            const scenarioName = document.getElementById('scenarioSelect').value;
            if (!scenarioName) return;

            try {
                const response = await fetch('/api/load-scenario', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ scenario_name: scenarioName })
                });
                const data = await response.json();
                
                if (data.success) {
                    showStatus('scenarios', `‚úÖ ${data.message}`, 'success');
                } else {
                    showStatus('scenarios', `‚ùå ${data.message}`, 'error');
                }
            } catch (error) {
                showStatus('scenarios', 'Fehler beim Laden: ' + error.message, 'error');
            }
        }

        // File Upload Setup
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            // Drag & Drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    uploadFile(files[0]);
                }
            });

            // File Input Change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    uploadFile(e.target.files[0]);
                }
            });

            // Initial load
            loadScenarios();
        });

        // File Upload
        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                showStatus('upload', 'üì§ Lade Datei hoch...', 'info');
                
                const response = await fetch('/api/upload-scenario', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`Server Error: ${response.status}`);
                }
                
                // W√§hrend des Uploads zeige Fortschritt
                showStatus('upload', 'üîÑ Datei verarbeitet... System wird vorbereitet...', 'info');
                
                const data = await response.json();
                
                if (data.success) {
                    showStatus('upload', `‚úÖ ${data.message}`, 'success');
                    loadScenarios(); // Reload scenarios
                    
                    // Erfolgreiche Bereitschaft best√§tigen
                    setTimeout(() => {
                        showStatus('upload', 'üéØ Perfekt! Das Lernset ist einsatzbereit. Du kannst sofort mit dem Lernen beginnen!', 'success');
                    }, 2000);
                } else {
                    showStatus('upload', `‚ùå ${data.message}`, 'error');
                }
            } catch (error) {
                showStatus('upload', 'Upload fehlgeschlagen: ' + error.message, 'error');
            }
        }

        // Agent Training
        async function quickPreparation() {
            try {
                showStatus('training', '‚ö° Schnell-Vorbereitung l√§uft... (ca. 30 Sekunden)', 'info');
                
                const response = await fetch('/api/train', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ algorithm: 'DQN', timesteps: 1000 })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStatus('training', `‚úÖ Schnell-Vorbereitung abgeschlossen! Reward: ${data.results.mean_reward.toFixed(2)}`, 'success');
                } else {
                    showStatus('training', `‚ùå ${data.message}`, 'error');
                }
            } catch (error) {
                showStatus('training', 'Schnell-Vorbereitung fehlgeschlagen: ' + error.message, 'error');
            }
        }

        async function trainAgent() {
            const algorithm = document.getElementById('algorithm').value;
            const timesteps = parseInt(document.getElementById('timesteps').value);

            try {
                showStatus('training', `üèãÔ∏è Vollst√§ndiges Training l√§uft... (${timesteps} Steps, kann mehrere Minuten dauern)`, 'info');
                
                const response = await fetch('/api/train', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ algorithm, timesteps })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStatus('training', `‚úÖ Training abgeschlossen! Algorithmus: ${data.results.algorithm}, Reward: ${data.results.mean_reward.toFixed(2)}, Erfolgsrate: ${data.results.success_rate.toFixed(1)}%`, 'success');
                } else {
                    showStatus('training', `‚ùå ${data.message}`, 'error');
                }
            } catch (error) {
                showStatus('training', 'Training fehlgeschlagen: ' + error.message, 'error');
            }
        }

        // Learning Session
        async function startSession() {
            try {
                const response = await fetch('/api/start-session', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    sessionActive = true;
                    currentTaskId = data.task_id;
                    document.getElementById('questionText').textContent = data.question;
                    document.getElementById('questionArea').classList.remove('hidden');
                    document.getElementById('sessionStats').classList.remove('hidden');
                    document.getElementById('answerInput').focus();
                } else {
                    showStatus('learning', `‚ùå ${data.message}`, 'error');
                }
            } catch (error) {
                showStatus('learning', 'Fehler beim Starten: ' + error.message, 'error');
            }
        }

        async function submitAnswer() {
            if (!sessionActive || !currentTaskId) return;

            const answer = document.getElementById('answerInput').value.trim();
            if (!answer) return;

            try {
                const response = await fetch('/api/submit-answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answer, task_id: currentTaskId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Feedback anzeigen
                    const feedbackDiv = document.getElementById('feedback');
                    feedbackDiv.innerHTML = `<div class="feedback ${data.is_correct ? 'correct' : 'incorrect'}">${data.feedback}</div>`;
                    
                    // Statistiken aktualisieren
                    if (data.stats) {
                        document.getElementById('questionsAnswered').textContent = data.stats.questions_answered;
                        document.getElementById('accuracy').textContent = data.stats.accuracy + '%';
                        document.getElementById('currentStreak').textContent = data.stats.current_streak;
                    }
                    
                    // N√§chste Frage oder Session beenden
                    if (!data.session_complete && data.next_question) {
                        setTimeout(() => {
                            currentTaskId = data.next_task_id;
                            document.getElementById('questionText').textContent = data.next_question;
                            document.getElementById('answerInput').value = '';
                            document.getElementById('answerInput').focus();
                            feedbackDiv.innerHTML = '';
                        }, 2000);
                    } else {
                        setTimeout(() => {
                            sessionActive = false;
                            document.getElementById('questionArea').classList.add('hidden');
                            feedbackDiv.innerHTML = '<div class="status success">üéâ Session abgeschlossen!</div>';
                        }, 3000);
                    }
                }
            } catch (error) {
                showStatus('learning', 'Fehler beim Senden: ' + error.message, 'error');
            }
        }

        // Spaced Repetition
        async function loadSpacedRepetition() {
            try {
                // Pr√ºfe, ob bereits eine Session gestartet wurde
                const sessionWarning = document.getElementById('sessionWarning');
                if (!sessionActive && sessionWarning) {
                    sessionWarning.style.display = 'block';
                } else if (sessionWarning) {
                    sessionWarning.style.display = 'none';
                }
                
                showStatus('repetition', 'Lade f√§llige Karten...', 'info');
                
                // Stelle sicher, dass ein Szenario geladen ist
                await ensureScenarioLoaded();
                
                const response = await fetch('/api/spaced-repetition/due');
                const data = await response.json();
                
                if (data.success) {
                    // Defensive Programmierung - Pr√ºfe ob Elemente existieren
                    const cardsDueElement = document.getElementById('cardsDue');
                    if (cardsDueElement) {
                        cardsDueElement.textContent = data.cards_due;
                    }
                    
                    const cardsContainer = document.getElementById('spacedCards');
                    if (!cardsContainer) {
                        throw new Error('spacedCards container nicht gefunden');
                    }
                    
                    cardsContainer.innerHTML = '';
                    
                    if (data.cards && data.cards.length > 0) {
                        data.cards.forEach(card => {
                            const cardDiv = document.createElement('div');
                            cardDiv.className = 'spaced-card';
                            cardDiv.innerHTML = `
                                <div class="card-question">
                                    <h4>${card.question}</h4>
                                    <p><strong>Kategorie:</strong> ${card.category}</p>
                                    <div class="card-stats">
                                        <span>Wiederholungen: ${card.repetitions}</span> | 
                                        <span>Intervall: ${card.interval} Tag(e)</span> | 
                                        <span>Easiness: ${card.easiness_factor.toFixed(2)}</span>
                                    </div>
                                </div>
                                
                                <div class="answer-section" id="answer-${card.id}">
                                    <div class="answer-input">
                                        <input type="text" id="input-${card.id}" placeholder="Ihre Antwort..." class="form-control">
                                        <button onclick="checkAnswer('${card.id}')" class="btn btn-primary">Antwort pr√ºfen</button>
                                    </div>
                                </div>
                                
                                <div class="quality-section" id="quality-${card.id}" style="display: none;">
                                    <div class="answer-feedback" id="feedback-${card.id}"></div>
                                    <p><strong>Wie schwer war das f√ºr Sie?</strong></p>
                                    <div class="quality-buttons">
                                        <button class="btn btn-danger quality-btn" onclick="reviewCard('${card.id}', 0)">0 - Blackout</button>
                                        <button class="btn btn-danger quality-btn" onclick="reviewCard('${card.id}', 1)">1 - Sehr schwer</button>
                                        <button class="btn btn-warning quality-btn" onclick="reviewCard('${card.id}', 2)">2 - Schwer</button>
                                        <button class="btn btn-secondary quality-btn" onclick="reviewCard('${card.id}', 3)">3 - Normal</button>
                                        <button class="btn btn-success quality-btn" onclick="reviewCard('${card.id}', 4)">4 - Leicht</button>
                                        <button class="btn btn-success quality-btn" onclick="reviewCard('${card.id}', 5)">5 - Sehr leicht</button>
                                    </div>
                                </div>
                            `;
                            cardsContainer.appendChild(cardDiv);
                        });
                    } else {
                        cardsContainer.innerHTML = '<div class="status info">üéâ Keine Karten f√§llig!</div>';
                    }
                    
                    showStatus('repetition', `${data.cards_due} Karten geladen`, 'success');
                } else {
                    showStatus('repetition', 'Fehler: ' + data.message, 'error');
                }
            } catch (error) {
                showStatus('repetition', 'Fehler beim Laden: ' + error.message, 'error');
            }
        }

        // Hilfsfunktion: Stelle sicher, dass ein Szenario geladen ist
        async function ensureScenarioLoaded() {
            try {
                const response = await fetch('/api/scenarios');
                const data = await response.json();
                
                if (data.scenarios && data.scenarios.length > 0) {
                    // Lade das erste verf√ºgbare Szenario
                    const loadResponse = await fetch('/api/load-scenario', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ scenario_name: data.scenarios[0] })
                    });
                    
                    if (loadResponse.ok) {
                        // Starte eine Session um Karten zu erstellen
                        await fetch('/api/start-session', { method: 'POST' });
                    }
                }
            } catch (error) {
                console.log('Fehler beim Laden des Szenarios:', error);
            }
        }

        async function checkAnswer(cardId) {
            const inputElement = document.getElementById(`input-${cardId}`);
            const userAnswer = inputElement.value.trim();
            
            if (!userAnswer) {
                alert('Bitte geben Sie eine Antwort ein!');
                return;
            }
            
            try {
                // Hole die korrekte Antwort vom Server
                const response = await fetch(`/api/spaced-repetition/check-answer/${cardId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answer: userAnswer })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Zeige Feedback
                    const feedbackElement = document.getElementById(`feedback-${cardId}`);
                    const isCorrect = data.is_correct;
                    
                    feedbackElement.innerHTML = `
                        <div class="answer-result ${isCorrect ? 'correct' : 'incorrect'}">
                            <strong>Ihre Antwort:</strong> "${userAnswer}"<br>
                            <strong>Korrekte Antwort:</strong> "${data.correct_answer}"<br>
                            <span class="${isCorrect ? 'text-success' : 'text-danger'}">
                                ${isCorrect ? '‚úÖ Richtig!' : '‚ùå Falsch'}
                            </span>
                        </div>
                    `;
                    
                    // Verstecke Antwort-Eingabe, zeige Bewertung
                    document.getElementById(`answer-${cardId}`).style.display = 'none';
                    document.getElementById(`quality-${cardId}`).style.display = 'block';
                    
                    // Speichere Antwort-Status f√ºr sp√§tere Verwendung
                    window.currentAnswers = window.currentAnswers || {};
                    window.currentAnswers[cardId] = {
                        userAnswer: userAnswer,
                        correctAnswer: data.correct_answer,
                        isCorrect: isCorrect
                    };
                } else {
                    alert('Fehler beim Pr√ºfen der Antwort: ' + data.message);
                }
            } catch (error) {
                alert('Fehler beim Pr√ºfen der Antwort: ' + error.message);
            }
        }

        async function reviewCard(cardId, quality) {
            try {
                // Hole die gespeicherte Antwort-Info
                const answerInfo = window.currentAnswers && window.currentAnswers[cardId];
                if (!answerInfo) {
                    alert('Bitte beantworten Sie die Frage zuerst!');
                    return;
                }
                
                // Intelligente Qualit√§ts-Anpassung basierend auf Korrektheit
                let adjustedQuality = quality;
                if (!answerInfo.isCorrect) {
                    // Bei falscher Antwort: Qualit√§t maximal 2 (schwer)
                    adjustedQuality = Math.min(quality, 2);
                } else {
                    // Bei richtiger Antwort: Qualit√§t mindestens 3 (normal)
                    adjustedQuality = Math.max(quality, 3);
                }
                
                const response = await fetch('/api/spaced-repetition/review', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        card_id: cardId, 
                        quality: adjustedQuality,
                        user_answer: answerInfo.userAnswer,
                        is_correct: answerInfo.isCorrect
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Entferne die Karte aus der Ansicht
                    const cardElement = document.querySelector(`[onclick*="${cardId}"]`).closest('.spaced-card');
                    cardElement.style.animation = 'fadeOut 0.5s ease-out';
                    setTimeout(() => {
                        cardElement.remove();
                        
                        // Update die Anzahl f√§lliger Karten
                        const remainingCards = document.querySelectorAll('.spaced-card').length;
                        const cardsDueElement = document.getElementById('cardsDue');
                        if (cardsDueElement) {
                            cardsDueElement.textContent = remainingCards;
                        }
                        
                        if (remainingCards === 0) {
                            document.getElementById('spacedCards').innerHTML = 
                                '<div class="status success">üéâ Alle Karten bearbeitet! Gut gemacht!</div>';
                        }
                    }, 500);
                    
                    // Vereinfachte Wiederholungsanzeige - nur Intervall, kein Datum
                    let reviewMessage = 'Karte bewertet!';
                    
                    // Verwende das SM-2 Intervall f√ºr die Anzeige
                    const intervalDays = data.interval_days || 1;
                    
                    if (intervalDays === 0) {
                        reviewMessage += ' N√§chste Wiederholung: sofort';
                    } else if (intervalDays === 1) {
                        reviewMessage += ' N√§chste Wiederholung: 1 Tag';
                    } else {
                        reviewMessage += ` N√§chste Wiederholung: ${intervalDays} Tage`;
                    }
                    
                    showStatus('repetition', reviewMessage, 'success');
                        
                    // L√∂sche die gespeicherte Antwort
                    delete window.currentAnswers[cardId];
                } else {
                    showStatus('repetition', 'Fehler beim Speichern: ' + data.message, 'error');
                }
            } catch (error) {
                showStatus('repetition', 'Fehler beim Bewerten: ' + error.message, 'error');
            }
        }

        // Auto Training
        async function scheduleAutoTraining() {
            const scenarioName = document.getElementById('autoScenario').value;
            const algorithm = document.getElementById('autoAlgorithm').value;
            const priority = document.getElementById('autoPriority').value;

            if (!scenarioName) {
                showStatus('auto-training', 'Bitte w√§hle ein Szenario aus', 'error');
                return;
            }

            try {
                const response = await fetch('/api/auto-train', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        scenario_name: scenarioName, 
                        algorithm, 
                        priority,
                        timesteps: 10000
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStatus('auto-training', `‚úÖ ${data.message}`, 'success');
                    checkAutoTrainingStatus();
                } else {
                    showStatus('auto-training', `‚ùå ${data.message}`, 'error');
                }
            } catch (error) {
                showStatus('auto-training', 'Fehler beim Planen: ' + error.message, 'error');
            }
        }

        async function checkAutoTrainingStatus() {
            try {
                const response = await fetch('/api/auto-train/status');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('jobsQueued').textContent = data.jobs_queued;
                    document.getElementById('jobsRunning').textContent = data.jobs_running;
                    document.getElementById('jobsCompleted').textContent = data.jobs_completed;
                }
            } catch (error) {
                console.error('Status check error:', error);
            }
        }

        // Utility Functions
        function showStatus(containerId, message, type) {
            // Versuche verschiedene M√∂glichkeiten, das Status-Element zu finden
            const container = document.getElementById(containerId + 'Status') || 
                             document.getElementById(containerId)?.querySelector('.status') ||
                             document.getElementById(containerId);
            
            if (container) {
                container.innerHTML = `<div class="status ${type}">${message}</div>`;
                
                // Auto-clear nach 5 Sekunden f√ºr success/info messages
                if (type === 'success' || type === 'info') {
                    setTimeout(() => {
                        if (container.innerHTML.includes(message)) {
                            container.innerHTML = '';
                        }
                    }, 5000);
                }
            } else {
                // Fallback: Console-Log wenn kein Element gefunden wird
                console.log(`Status f√ºr ${containerId}: ${message} (${type})`);
            }
        }

        // Enter key support
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab && activeTab.id === 'learning' && sessionActive) {
                    submitAnswer();
                }
            }
        });

        // Create Sample Scenarios
        async function createSampleScenarios() {
            try {
                showStatus('upload', 'üîÑ Erstelle Beispiel-Szenarien...', 'info');
                
                const response = await fetch('/api/create-sample-scenarios', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStatus('upload', `‚úÖ ${data.message}`, 'success');
                    loadScenarios(); // Reload scenarios
                } else {
                    showStatus('upload', `‚ùå ${data.message}`, 'error');
                }
            } catch (error) {
                showStatus('upload', 'Fehler beim Erstellen: ' + error.message, 'error');
            }
        }

        // Auto-refresh training status
        setInterval(() => {
            const autoTab = document.getElementById('auto-training');
            if (autoTab && autoTab.classList.contains('active')) {
                checkAutoTrainingStatus();
            }
        }, 5000);
    </script>
</body>
</html>
